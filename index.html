<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tuition One-Off Fee (Checkbox Days)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input[type="number"], input[type="date"], button {
      width: 100%; padding: 8px; margin: 5px 0 10px 0;
      border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
    }
    .checkbox-group { margin-bottom: 10px; }
    .checkbox-group label { font-weight: normal; display: inline-block; margin-right: 15px; }
    button { background: #2c3e50; color: #fff; border: 0; cursor: pointer; }
    .results { margin-top: 12px; padding: 10px; background: #f5f7f9; border: 1px solid #e3e7eb; border-radius: 6px; }
    .hidden { display: none; }
    .note { margin-top: 15px; font-style: italic; color: #555; }
  </style>
</head>
<body>
  <h3>Tuition One-Off Fee</h3>

  <label for="startDate">Start Date</label>
  <input type="date" id="startDate" required>

  <label for="monthlyFee">Total Monthly Fee (Tuition Cost Of All Kids) (Â£)</label>
  <input type="number" id="monthlyFee" min="0" step="0.01" value="100" required>

  <label>Select Tuition Days</label>
  <div class="checkbox-group" id="dayCheckboxes">
    <label><input type="checkbox" value="6" class="dayCheckbox"> Saturday</label>
    <label><input type="checkbox" value="0" class="dayCheckbox"> Sunday</label>
    <label><input type="checkbox" value="3" class="dayCheckbox"> Wednesday</label>
  </div>

  <div id="satHoursWrap" class="hidden">
    <label for="saturdayHours">Saturday Hours</label>
    <input type="number" id="saturdayHours" min="0" step="0.1" value="2">
  </div>

  <div id="sunHoursWrap" class="hidden">
    <label for="sundayHours">Sunday Hours</label>
    <input type="number" id="sundayHours" min="0" step="0.1" value="1">
  </div>

  <div id="wedHoursWrap" class="hidden">
    <label for="wednesdayHours">Wednesday Hours</label>
    <input type="number" id="wednesdayHours" min="0" step="0.1" value="1.5">
  </div>

  <button id="calcBtn">Calculate</button>

  <div class="results" id="results" style="display:none;">
    <p><strong>Tuition One-Off:</strong> <span id="tuitionOneOff"></span></p>
    <p><strong>Weeks Charged:</strong> <span id="weeksCharged"></span></p>
  </div>

  <!-- >>> Use the Widget SDK (not main.js) -->
  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script>
    // Keep last result for the widget lifecycle
    window._latestResult = {};

    function updateHoursVisibility() {
      const satChecked = document.querySelector('.dayCheckbox[value="6"]').checked;
      const sunChecked = document.querySelector('.dayCheckbox[value="0"]').checked;
      const wedChecked = document.querySelector('.dayCheckbox[value="3"]').checked;

      toggleWrap('satHoursWrap', 'saturdayHours', satChecked);
      toggleWrap('sunHoursWrap', 'sundayHours', sunChecked);
      toggleWrap('wedHoursWrap', 'wednesdayHours', wedChecked);
    }

    function toggleWrap(wrapId, inputId, show) {
      const wrap = document.getElementById(wrapId);
      const input = document.getElementById(inputId);
      if (!wrap || !input) return;
      if (show) {
        wrap.classList.remove('hidden');
        input.setAttribute('required', 'required');
      } else {
        wrap.classList.add('hidden');
        input.removeAttribute('required');
      }
    }

    function getSelectedDays() {
      return Array.from(document.querySelectorAll('.dayCheckbox:checked')).map(cb => cb.value);
    }

    function calcTuitionOneOff() {
      const startDateVal = document.getElementById('startDate').value;
      const monthlyFee = parseFloat(document.getElementById('monthlyFee').value || 0);
      const saturdayHours = parseFloat(document.getElementById('saturdayHours').value || 0);
      const sundayHours = parseFloat(document.getElementById('sundayHours').value || 0);
      const wednesdayHours = parseFloat(document.getElementById('wednesdayHours').value || 0);

      const selectedDays = getSelectedDays();

      if (!startDateVal || !isFinite(monthlyFee) || selectedDays.length === 0) {
        alert('Please enter valid details and select at least one day.');
        return;
      }

      const startDate = new Date(startDateVal);

      let totalWeeklyHours = 0;
      if (selectedDays.includes('6')) totalWeeklyHours += saturdayHours;
      if (selectedDays.includes('0')) totalWeeklyHours += sundayHours;
      if (selectedDays.includes('3')) totalWeeklyHours += wednesdayHours;

      if (totalWeeklyHours <= 0) {
        alert('Total weekly hours is 0. Please check your hours and day selection.');
        return;
      }

      const hourlyRate = monthlyFee / (totalWeeklyHours * 4);

      const year = startDate.getFullYear();
      const month = startDate.getMonth();
      const day = startDate.getDate();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      let tuitionOneOff = 0;
      const weeksCharged = new Set();

      for (let d = day; d <= daysInMonth; d++) {
        const current = new Date(year, month, d);
        const weekKey = `${current.getFullYear()}-${current.getMonth()}-${Math.floor((current.getDate() - 1) / 7)}`;

        if (selectedDays.includes(current.getDay().toString())) {
          if (current.getDay() === 6) tuitionOneOff += saturdayHours * hourlyRate;
          if (current.getDay() === 0) tuitionOneOff += sundayHours * hourlyRate;
          if (current.getDay() === 3) tuitionOneOff += wednesdayHours * hourlyRate;
          weeksCharged.add(weekKey);
        }
      }

      document.getElementById('tuitionOneOff').textContent = tuitionOneOff.toFixed(2);
      document.getElementById('weeksCharged').textContent = weeksCharged.size;
      document.getElementById('results').style.display = 'block';

      // Save for Jotform (even if you don't actually use it)
      window._latestResult = {
        tuitionOneOff: tuitionOneOff.toFixed(2),
        weeksCharged: weeksCharged.size
      };
    }

    // UI events
    document.getElementById('calcBtn').addEventListener('click', calcTuitionOneOff);
    document.getElementById('dayCheckboxes').addEventListener('change', updateHoursVisibility);
    document.addEventListener('DOMContentLoaded', updateHoursVisibility);

    // ---------- Jotform Widget lifecycle (the crucial part) ----------
    function resize() {
      const h = document.documentElement.scrollHeight || document.body.scrollHeight || 300;
      JFCustomWidget.setHeight(h);
    }
    // Keep height in sync
    try { new ResizeObserver(resize).observe(document.body); } catch (e) {}

    // Fire when the widget iframe is ready
    JFCustomWidget.subscribe("ready", resize);

    // If the widget is required, tell Jotform it's valid (and provide a value)
    JFCustomWidget.subscribe("validate", function () {
      JFCustomWidget.sendSubmit({ valid: true, value: JSON.stringify(window._latestResult || {}) });
    });

    // On form submit, return something so the parent can finalize
    JFCustomWidget.subscribe("submit", function () {
      JFCustomWidget.sendSubmit({ value: JSON.stringify(window._latestResult || {}) });
    });
    // ---------------------------------------------------------------
  </script>
</body>
</html>
